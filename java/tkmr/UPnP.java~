package tkmr;

import java.awt.*;
import java.awt.event.*;
import java.net.*;

public class UPnP{
    private static int BUFFER_SIZE = 100000;
    public UPnP()
    {

    }

    public DatagramPacket listenUDP(int port, int timeout)
    {
        //        try{
        byte[] data = new byte[BUFFER_SIZE];
        DatagramPacket packet = new DatagramPacket(data, BUFFER_SIZE);
        DatagramSocket socket = new DatagramSocket(port);
        socket.setSoTimeout(timeout);
        socket.receive(packet);
        //        }catch(SocketTimeoutException e){
        //        }
        return packet;
    }

    public String discoverRouter()
    {
        try{
            // UDPパケットを送信する先となるブロードキャストアドレス (12345番ポート)
            InetSocketAddress remoteAddress = new InetSocketAddress("239.255.255.250", 1900);

            // UDPパケットに含めるデータ
            byte[] sendBuffer =
                "M-SEARCH * HTTP/1.1\r\n"+
                "MX: 3\r\n"+
                "HOST: 239.255.255.250:1900\r\n"+
                "MAN: \"ssdp:discover\"\r\n"
                "ST: urn:schemas-upnp-org:service:WANPPPConnection:1\r\n\r\n".getBytes(); //"UTF-8");

            //byte[] sendBuffer2 = new byte[sendBuffer.length-6];
            //for(int i=3,j=0; i<sendBuffer.length-3; i++,j++){
            //    sendBuffer2[j] = sendBuffer[i];
            //}

            // UDPパケット
            DatagramPacket sendPacket = new DatagramPacket(sendBuffer, sendBuffer.length, remoteAddress);

            // DatagramSocketインスタンスを生成して、UDPパケットを送信
            new DatagramSocket().send(sendPacket);

            DatagramPacket receivePacket = listenUDP(1900, 3000);
            String routerMessage = new String(receivePacket.getData(), 0, receivePacket.getLength());
            return routerMessage;
        }
        catch(Exception ee){
        }
    }
}